<!DOCTYPE html>

<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <title>交通大数据</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="css/app.css" />
</head>

<body class="bg02">
    <header class="header">
        <h3>交通大数据</h3>
    </header>

    <div class="wrapper">
        <div class="container-fluid">
            <div class="row fill-h">
                <div class="col-lg-7 fill-h">
                    <div class="xpanel-wrapper xpanel-wrapper-1">
                        <div class="xpanel">
                            <div class="fill-h" id="heatmap"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5 fill-h">
                    <div class="xpanel-wrapper xpanel-wrapper-2">
                        <div class="xpanel">
                            <div class="fill-h" id="histogram"></div>
                        </div>
                    </div>
                    <div class="xpanel-wrapper xpanel-wrapper-2">
                        <div class="xpanel">
                            <div class="fill-h" id="heatgrid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
    <script type="text/javascript"
        src="https://api.map.baidu.com/api?v=2.0&ak=ItgeBPfuhdZyMq54TXFjrN36xWQblUqq"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/echarts.min.js"></script>
    <script type="text/javascript" src="js/echarts-bmap.js"></script>
    <script type="text/javascript" src="js/heatmap.js"></script>
    <script type="text/javascript" src="js/heatgrid.js"></script>
    <script type="text/javascript" src="js/histogram.js"></script>
    <script type="text/javascript" src="js/theme/chalk.js"></script>
    <script type="text/javascript">
        $(function () {
            $.getJSON('./data/data.json').done(function (data) {
                var heatmapChart = null
                var heatgridChart = null
                var histogramChart = null
                var baseOption = null

                function getBaseOpt(timedata) {
                    // set timeline base opt
                    var bmapOpt = {
                        baseOption: {
                            timeline: {
                                axisType: 'category',
                                autoPlay: true,
                                playInterval: 1000,
                                data: timedata,
                                label: {
                                    formatter: function (s) {
                                        return s;
                                    }
                                }
                            }
                        }
                    }
                    return bmapOpt;
                }

                function controlInit(opt, chart) {
                    // timelineChart = echarts.init(document.getElementById("timeline"))
                    // timelineChart.setOption(opt)
                    chart.setOption(opt)
                }

                function heatmapInit(opt) {
                    heatmapChart = echarts.init(document.getElementById("heatmap"))
                    heatmapChart.setOption(opt)
                    let bmap = heatmapChart.getModel().getComponent('bmap').getBMap()
                    bmap.addControl(new BMap.MapTypeControl())
                }

                function heatgridInit(opt) {
                    heatgridChart = echarts.init(document.getElementById("heatgrid"));
                    heatgridChart.setOption(opt)
                }

                function histogramInit(opt) {
                    histogramChart = echarts.init(document.getElementById("histogram"), "chalk");
                    histogramChart.setOption(opt)
                }
                const timedata = data['key']
                const heatmapData = data['heatmap']
                const histogramData = data['histogram']
                const heatgridData = data['heatgrid']

                hmdata = {
                    'key': timedata[0],
                    'val': heatmapData[0]
                }
                hisdata = {
                    'key': timedata[0],
                    'val': histogramData[0]
                }
                hgdata = {
                    'key': timedata[0],
                    'val': heatgridData[0]
                }
                var heatmapOpt = getHeatmapOpt(hmdata)
                var histogramOpt = getHistogramOpt(hisdata)
                var heatgridOpt = getHeatgridOpt(hgdata)
                const baseOpt = getBaseOpt(timedata)


                heatmapInit(heatmapOpt)
                histogramInit(histogramOpt)
                heatgridInit(heatgridOpt)
                controlInit(baseOpt, heatmapChart)


                heatmapChart.on('timelinechanged', function (timeLineIndex) {
                    // 设置 每个series里的xAxis里的值
                    var arrIndex = parseInt(timeLineIndex.currentIndex);

                    hmdata = {
                        'key': timedata[arrIndex],
                        'val': heatmapData[arrIndex]
                    }
                    hisdata = {
                        'key': timedata[arrIndex],
                        'val': histogramData[arrIndex]
                    }
                    hgdata = {
                        'key': timedata[arrIndex],
                        'val': heatgridData[arrIndex]
                    }
                    heatmapOpt = getHeatmapOpt(hmdata)
                    heatmapChart.setOption(heatmapOpt)
                    histogramOpt = getHistogramOpt(hisdata)
                    histogramChart.setOption(histogramOpt)
                    heatgridOpt = getHeatgridOpt(hgdata)
                    heatgridChart.setOption(heatgridOpt)
                });

            });

            window.onresize = function () {
                bmapChart.resize();
                heatmapChart.resize();
                coordChart.resize();
            };
        });
    </script>
</body>

</html>